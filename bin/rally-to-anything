import click
import toml
import tqdm

import src.rally
import src.jira


@click.group()
def cli():
    pass


@cli.command()
@click.option("-v", "--verbose", default=False, is_flag=True)
@click.option("-c", "--clear-cache", default=False, is_flag=True)
@click.option("-a", "--attachments", default=False, is_flag=True)
@click.option("--config", type=click.File(), required=True, default="./config.toml")
def dump_rally(verbose, clear_cache, attachments, config):
    config = toml.load(config)
    click.echo("Dumping from Rally...")
    rally = src.rally.Rally(config, verbose)
    if verbose and clear_cache:
        click.echo("Clearing local Rally artifact cache...")

    for artifact in tqdm.tqdm(rally.artifacts, desc="Artifacts"):
        if attachments:
            for attachment in tqdm.tqdm(
                artifact.attachments(),
                desc="Attachments",
                total=artifact.number_of_attachments,
                disable=artifact.number_of_attachments == 0,
            ):
                attachment.cache_to_disk(force=clear_cache)

        artifact.cache_to_disk(force=clear_cache)


@cli.command()
@click.option("-v", "--verbose", default=False, is_flag=True)
@click.option(
    "--output-file",
    required=True,
    default="./rally-to-anything/jira/rally-to-jira.json",
)
@click.option("--config", type=click.File(), required=True, default="./config.toml")
def generate_jira_import_json(verbose, output_file, config):
    config = toml.load(config)
    click.echo("Generating Rally To Jira JSON...")
    migrator = src.jira.JiraMigrator(config, verbose)
    migrator.build_import_json(output_file)
    click.echo(
        f"{output_file} generation complete. Upload to the JSON Importer of your Jira instance."
        " More info on how to do so here: "
        "https://confluence.atlassian.com/adminjiraserver/importing-data-from-json-938847609.html"
    )
    click.echo(
        "After importing the issues, you'll want to upload Rally attachments using "
        "the migrate-attachments-to-jira command."
    )


if __name__ == "__main__":
    cli()
